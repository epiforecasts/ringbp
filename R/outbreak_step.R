#' Move forward one generation in the branching process
#'
#' @author Joel Hellewell
#'
#' @param case_data a `data.table`: cases in outbreak so far; initially
#'   generated by [outbreak_setup()]
#' @inheritParams outbreak_model
#' @param onset_to_isolation a `function` that samples from the
#'   onset-to-hospitalisation delay Weibull distribution
#'
#' @importFrom data.table data.table rbindlist
#' @importFrom stats rbinom
#' @importFrom stats runif
#'
#' @return A `list` with three elements:
#'   1. `$cases`: a `data.table` with case data
#'   2. `$effective_r0`: a `numeric` with the effective reproduction number
#'   3. `$cases_in_gen`: a `numeric` with the number of new cases in that
#'   generation
#' @autoglobal
#' @export
#'
#' @examples
#' # incubation period sampling function
#' incubation_period <- \(x) rweibull(n = x, shape = 2.32, scale = 6.49)
#' # delay distribution sampling function
#' onset_to_isolation <- \(x) rweibull(n = x, shape = 1.65, scale = 4.28)
#' # generate initial cases
#' case_data <- outbreak_setup(
#'   num.initial.cases = 5,
#'   incubation_period = incubation_period,
#'   onset_to_isolation = onset_to_isolation,
#'   k = 1.95,
#'   prop.asym = 0
#' )
#' case_data
#' # generate next generation of cases
#' out <- outbreak_step(
#'   case_data = case_data,
#'   disp.iso = 1,
#'   disp.com = 0.16,
#'   disp.subclin = 0.16,
#'   r0isolated = 0,
#'   r0subclin = 1.25,
#'   r0community = 2.5,
#'   prop.asym = 0,
#'   incubation_period = incubation_period,
#'   onset_to_isolation = onset_to_isolation,
#'   prop.ascertain = 0,
#'   k = 1.95,
#'   quarantine = FALSE
#' )
#' case_data <- out[[1]]
#' case_data
outbreak_step <- function(case_data = NULL, disp.iso = NULL, disp.com = NULL,
                          r0isolated = NULL, r0community = NULL,
                          prop.asym = NULL, incubation_period = NULL,
                          onset_to_isolation = NULL, prop.ascertain = NULL,
                          k = NULL, quarantine = NULL, r0subclin = NULL,
                          disp.subclin = NULL) {

  # For each case in case_data, draw new_cases from a negative binomial distribution
  # with an R0 and dispersion dependent on if isolated=TRUE
  case_data[, new_cases := rnbinom(
    .N,
    size = fifelse(isolated, disp.iso, fifelse(asym, disp.subclin, disp.com)),
    mu = fifelse(isolated, r0isolated, fifelse(asym, r0subclin, r0community))
  )]

  # Select cases that have generated any new cases
  new_case_data <- case_data[new_cases > 0]
  # The total new cases generated
  total_new_cases <- case_data[, sum(new_cases), ]

  # If no new cases drawn, outbreak is over so return case_data
  if (total_new_cases == 0) {
    # If everyone is isolated it means that either control has worked or everyone has had a chance to infect but didn't
    case_data$isolated <- TRUE

    effective_r0 <- 0
    cases_in_gen <- 0
    out <- list(case_data, effective_r0, cases_in_gen)
    names(out) <- c("cases", "effective_r0", "cases_in_gen")

    return(out)
  }

  # Compile a data.table for all new cases, new_cases is the amount of people that each infector has infected
  prob_samples <- new_case_data[, list(
    # time when new cases were exposed, a draw from serial interval based on infector's onset
    exposure = inf_fn(rep(onset, new_cases), k),
    # records the infector of each new person
    infector = rep(caseid, new_cases),
    # records when infector was isolated    
    infector_iso_time = rep(isolated_time, new_cases),
    # records if infector asymptomatic
    infector_asym = rep(asym, new_cases),
    # cases whose parents are asymptomatic are automatically missed;
    # will draw this for infector_asym == FALSE
    missed = TRUE,
    # sample from the incubation period for each new person
    incubfn_sample = incubation_period(total_new_cases),
    isolated = FALSE, new_cases = NA
  )][,
    # draws a sample to see if this person is asymptomatic
    asym := runif(.N) < prop.asym
  ][
    exposure < infector_iso_time
  ][, # filter out new cases prevented by isolation
      `:=`(# onset of new case is exposure + incubation period sample
        onset = exposure + incubfn_sample
  )]

  # draw a sample for missing
  prob_samples[infector_asym == FALSE, missed := runif(.N) > prop.ascertain]

  prob_samples[, isolated_time := {
    ref_time <- onset + onset_to_isolation(.N)
    fifelse(
      # If asymptomatic, never isolated: time is Inf
      asym == TRUE, Inf, fifelse(
      # If not asymptomatic, but are missed, isolated at your symptom onset
      missed == TRUE, ref_time,
      if (!is.null(quarantine) && (quarantine == TRUE)) infector_iso_time else
      # if symptomatic & traced, and infectors not quarantined
      pmin(ref_time, pmax(onset, infector_iso_time))
    ))}]

  # Chop out unneeded sample columns
  prob_samples[, c("incubfn_sample", "infector_iso_time", "infector_asym") := NULL]
  # Set new case ids for new people
  prob_samples[, caseid := case_data[.N, caseid] + seq_len(.N) ]

  ## Number of new cases
  cases_in_gen <- nrow(prob_samples)

  ## Estimate the effective r0
  effective_r0 <- cases_in_gen / case_data[isolated == FALSE, .N]

  # Everyone in case_data so far has had their chance to infect and are therefore considered isolated
  case_data$isolated <- TRUE

  # bind original cases + new secondary cases
  case_data <- data.table::rbindlist(list(case_data, prob_samples),
                                     use.names = TRUE)

  # Return
  out <- list(case_data, effective_r0, cases_in_gen)
  names(out) <- c("cases", "effective_r0", "cases_in_gen")

  return(out)
}
